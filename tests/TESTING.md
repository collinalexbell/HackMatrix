# Test Strategy
- **Scope:** Cover Wayland compositor boot, input plumbing, and ZMQ control paths with lightweight gtests in `tests/`. C++ unit tests for pure logic (API/dynamic objects) live alongside end-to-end compositor tests.
- **Binaries:** End-to-end Wayland tests launch `./matrix-wlroots-debug` via the `launch` script (`start_compositor_with_env` sets `MATRIX_WLROOTS_BIN`). Debug build keeps `/tmp` logging enabled; release build stays clean.
- **Harness shape:** Tests own the compositor lifecycle. They clear `/tmp/matrix-wlroots-output.log` (and other tmp logs), start the compositor under `./launch --in-wm`, wait for pid/log readiness, and always shut it down via the ZMQ `QUIT` command; a final `kill -9` is used only as a last resort to avoid orphans.
- **Input simulation:** Keyboard events are injected through the ZMQ `KEY_REPLAY` API (see helpers in `tests/wayland_menu_spec.cpp`). This keeps input on the engine path instead of desktop tooling. Some legacy focus checks use `xdotool` when available.
- **Log/assert patterns:** Helpers poll for log markers (`mapped`, key handler symbols, renderer samples) and for file existence to confirm client actions (e.g., menu script markers, neofetch output, screenshots). Tests truncate renderer/wayland app logs to avoid cross-test contamination.
- **Renderer/state trace:** Debug builds emit `/tmp/matrix-wlroots-output.log` and `/tmp/matrix-wlroots-wm.log` with Wayland entity/texture/position logs and STATUS samples; controls/hotkey tests assert against these to catch focus, unfocus, and render-path regressions.
- **ZMQ endpoints:** Tests rely on `VOXEL_API_ADDR_FOR_TEST` when set, otherwise `tcp://127.0.0.1:3345`. The STATUS endpoint validates engine vitals (`total_entities`, Wayland app count, focused app flag, camera position) before deeper assertions such as unfocus/movement checks.
- **Client launch:** Menu/terminal scenarios override `MENU_PROGRAM` to a small script that execs `foot`; key replay then types commands inside the terminal (touch file, run neofetch, redirect output). Tests wait for Wayland map events before typing to reduce flakes.
- **Feature flags/tools:** Some assertions are skipped if optional tools are missing (e.g., `neofetch`, `xdotool`) or if render tmp logging is compiled out. Screenshot test expects `screenshots/` writable.
- **Focused runs:** `tests/wayland_basic.cpp` supports `--all` or `WAYLAND_TEST_FILTER`; otherwise it defaults to the fast backend detection test. Other gtests can be filtered with standard `--gtest_filter`.
