#sleep 5; VOXEL_API_BIND=tcp://*:3345 ./matrix
#sleep 5; WLR_BACKENDS=x11 VOXEL_API_BIND=tcp://*:3345 ./matrix-wlroots
BASE_DIR="$(cd "$(dirname "$0")" && pwd)"
export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/tmp/xdg-runtime-$USER}"
mkdir -p "$XDG_RUNTIME_DIR"
chmod 700 "$XDG_RUNTIME_DIR"
export LD_LIBRARY_PATH="$BASE_DIR/wlroots/build:$BASE_DIR/wlroots/build/subprojects/wayland/src:${LD_LIBRARY_PATH}"
# Force a known-good cursor theme/size so wlroots loads a real arrow instead of a garbled fallback.
export XCURSOR_THEME="${XCURSOR_THEME:-Adwaita}"
export XCURSOR_SIZE="${XCURSOR_SIZE:-24}"
export XCURSOR_PATH="${XCURSOR_PATH:-/usr/share/icons}"
# Force software cursors; some GPUs/DRM combos show corrupted hardware cursors.
export WLR_NO_HARDWARE_CURSORS=1
# Optional flags:
#   --in-wm     -> delay start when running inside another WM.
#   --headless  -> force wlroots headless backend (for TTY/headless use).
#   --drm       -> force wlroots DRM backend (run as a real compositor on TTY).
DELAY=0
BACKEND=""
while [ $# -gt 0 ]; do
  case "$1" in
    --in-wm)
      DELAY=5
      shift
      ;;
    --headless)
      BACKEND="headless"
      shift
      ;;
    --drm)
      BACKEND="drm"
      shift
      ;;
    *)
      break
      ;;
  esac
done

if [ -n "$BACKEND" ]; then
  export WLR_BACKENDS="$BACKEND"
  if [ "$BACKEND" = "drm" ]; then
    # Prefer logind for seat access when running on a TTY.
    export LIBSEAT_BACKEND="${LIBSEAT_BACKEND:-logind}"
    # Pick a predictable primary DRM device when none was provided so hybrid GPU
    # setups don't accidentally render on a headless card.
    if [ -z "${WLR_DRM_DEVICES:-}" ] && [ -e /dev/dri/card0 ]; then
      export WLR_DRM_DEVICES="/dev/dri/card0"
    fi
    # Ensure XDG_RUNTIME_DIR exists; logind normally sets this.
    if [ -z "${XDG_RUNTIME_DIR:-}" ]; then
      export XDG_RUNTIME_DIR="/run/user/$(id -u)"
      mkdir -p "$XDG_RUNTIME_DIR"
      chmod 700 "$XDG_RUNTIME_DIR"
    fi
  fi
fi

[ "$DELAY" -gt 0 ] && sleep "$DELAY"
BIN="${MATRIX_WLROOTS_BIN:-./matrix-debug}"
export ENABLE_RENDER_TMP_LOGS=1
export WLR_APP_SAMPLE_LOG=1
VOXEL_API_BIND=tcp://*:3345 "$BIN" "$@"
